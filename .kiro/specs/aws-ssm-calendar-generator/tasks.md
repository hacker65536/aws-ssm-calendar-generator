# 実装計画 - AWS SSM Change Calendar 休業日スケジュール管理ツール

- [x] 1. プロジェクト構造とコアインターフェースのセットアップ

  - aws-ssm-calendar-generator/ ルートディレクトリを作成
  - src/ ディレクトリ内に Python モジュール構造を作成
  - 適切な **init**.py ファイルで Python パッケージ構造をセットアップ
  - 依存関係とエントリーポイントで setup.py を設定
  - requirements.txt で必要なライブラリを定義
  - _要件: 要件 1, 要件 2_

- [x] 2. 設定管理システムの実装 (src/config.py)

  - [x] 2.1 設定データモデルと検証の作成

    - src/config.py に Configuration クラスを作成
    - 設定値の検証関数を実装
    - 環境変数オーバーライドのサポートを追加
    - _要件: 設計書拡張機能_

  - [x] 2.2 設定ファイル処理の実装

    - JSON フォーマットでの設定ファイル読み込みをコード化
    - デフォルト設定値とフォールバックメカニズムを追加
    - 複数ソースからの設定マージを実装
    - _要件: 設計書拡張機能_

  - [x] 2.3 設定管理テストの作成
    - tests/test_config.py に設定検証のユニットテストを作成
    - ファイル読み込みとマージロジックのテストを作成
    - 環境変数オーバーライド機能をテスト
    - _要件: 設計書拡張機能_

- [x] 3. AWS SSM クライアント統合の作成 (src/aws_client.py)

  - [x] 3.1 AWS 認証とクライアントセットアップの実装

    - src/aws_client.py に AWS クライアント初期化を作成
    - プロファイルとリージョンのサポートを追加
    - 認証失敗のエラーハンドリングを実装
    - _要件: 要件 1, 要件 4.3_

  - [x] 3.2 Change Calendar データ取得の実装

    - Change Calendar ドキュメントを取得するメソッドをコード化
    - カレンダー状態チェック機能を追加
    - カレンダー一覧と発見機能を実装
    - _要件: 要件 1, 要件 4.3_

  - [ ] 3.3 モッキングを使用した AWS クライアントテストの作成
    - tests/test_aws_client.py にテスト用のモック AWS レスポンスを作成
    - 認証処理のユニットテストを作成
    - エラーシナリオとフォールバック動作をテスト
    - _要件: 要件 1, 要件 4.3_

- [x] 4. 日本祝日管理システムの開発 (src/japanese_holidays.py)

  - [x] 4.1 祝日データモデルと構造の作成

    - src/japanese_holidays.py に Holiday と HolidayCollection クラスを作成
    - 高速検索のための効率的なデータ構造を実装
    - 統計とメタデータ追跡を追加
    - _要件: 要件 1_

  - [x] 4.2 祝日データダウンロードとキャッシュの実装

    - 内閣府 CSV ダウンロード用 HTTP クライアントをコード化
    - 自動エンコーディング検出と CSV 解析を追加
    - ~/.aws-ssm-calendar/cache/ ディレクトリに有効期限ロジック付きキャッシュを実装
    - _要件: 要件 1_

  - [x] 4.3 祝日検索と検証メソッドの実装

    - 日付による高速祝日検索をコード化
    - 日付範囲検索機能を追加
    - 次の祝日検索と統計を実装
    - _要件: 要件 1_

  - [x] 4.4 フォールバックデータとエラーハンドリングの追加

    - ネットワーク障害用の基本祝日データを実装
    - 解析エラーの適切な劣化を追加
    - リトライロジックとエラー回復をコード化
    - _要件: 要件 1_

  - [ ]\* 4.5 包括的な祝日システムテストの作成
    - tests/test_japanese_holidays.py にすべての祝日操作のユニットテストを作成
    - データダウンロードの統合テストを作成
    - キャッシュ動作と有効期限ロジックをテスト
    - _要件: 要件 1_

- [x] 5. 日時処理とタイムゾーン管理の作成 (src/datetime_handler.py)

  - [x] 5.1 日時解析と変換ユーティリティの実装

    - src/datetime_handler.py に複数フォーマットサポートを持つ柔軟な日時解析を作成
    - タイムゾーン変換と UTC 処理を追加
    - ICS 準拠の日時フォーマットを実装
    - _要件: 設計書拡張機能_

  - [x] 5.2 AWS 日時フォーマット処理の追加

    - AWS タイムスタンプフォーマット用の特定パーサーをコード化
    - 日時入力の検証を追加
    - 無効フォーマットのエラーハンドリングを実装
    - _要件: 設計書拡張機能_

  - [ ]\* 5.3 日時処理テストの作成
    - tests/test_datetime_handler.py に様々な日時フォーマットのテストを作成
    - タイムゾーン変換テストケースを作成
    - DST 遷移などのエッジケースをテスト
    - _要件: 設計書拡張機能_

- [x] 6. ICS ファイル生成システムの実装 (src/ics_generator.py)

  - [x] 6.1 ICS ジェネレーターコア機能の作成

    - src/ics_generator.py にカレンダー管理を持つ ICSGenerator クラスを作成
    - イベント作成とフォーマットを実装
    - 適切な ICS 標準準拠を追加
    - _要件: 要件 2_

  - [x] 6.2 Change Calendar イベント統合の追加

    - AWS イベントを ICS フォーマットに変換するメソッドをコード化
    - 適切なイベントプロパティとメタデータを実装
    - 一意 ID 生成とイベント分類を追加
    - _要件: 要件 2_

  - [x] 6.3 日本祝日の ICS 生成への統合

    - 適切なフォーマットでの祝日イベント作成をコード化
    - 祝日の終日イベント処理を追加
    - 祝日分類と説明を実装
    - _要件: 要件 2_

  - [x] 6.4 ファイル出力とエンコーディング処理の実装

    - UTF-8 サポート付き ICS ファイル書き込みをコード化
    - ファイルシステム操作のエラーハンドリングを追加
    - フォールバック保存メソッドを実装
    - _要件: 要件 2_

  - [ ]\* 6.5 ICS 生成テストの作成
    - tests/test_ics_generator.py に ICS フォーマット準拠のテストを作成
    - イベント作成とフォーマットのテストを作成
    - ファイル出力とエンコーディングシナリオをテスト
    - _要件: 要件 2_

- [x] 6.6 ICS 解析・可視化機能の実装 (src/calendar_analyzer.py)

  - [x] 6.6.1 ICS ファイル解析機能の作成

    - src/calendar_analyzer.py に ICSAnalyzer クラスを作成
    - ICS ファイルを構造化データとして解析する機能を実装
    - イベント情報抽出とプロパティ解析を追加
    - RFC 5545 準拠の検証機能を実装
    - _要件: 要件 3_

  - [x] 6.6.2 人間可読形式出力の実装

    - 解析データの日付順ソート表示を実装
    - 統計情報表示（総イベント数、対象期間、種類別集計）を追加
    - エラー検出・報告機能を実装
    - _要件: 要件 3_

  - [x] 6.6.3 複数形式対応の実装

    - 標準出力、JSON、CSV 形式での出力をサポート
    - 簡易出力形式（サマリー + イベントリスト）を実装
    - ISO8601 期間表示機能を追加
    - _要件: 要件 3_

  - [x] 6.6.4 ICS 比較・差分表示機能の実装

    - 2 つの ICS ファイル間の差分検出機能を実装
    - 時系列ソート、変更種別表示を追加
    - 詳細差分表示とサマリー情報を実装
    - _要件: 要件 4_

- [x] 7. コマンドラインインターフェースの開発 (src/cli.py)

  - [x] 7.1 CLI フレームワークとコマンド構造の作成

    - src/cli.py に Click フレームワークでメインエントリーポイントを作成
    - グローバルオプションと設定処理を実装
    - ヘルプシステムとコマンドドキュメントを追加
    - _要件: 設計書拡張機能_

  - [x] 7.1.1 CLI デフォルト設定の最適化実装

    - デフォルトログレベルを WARNING に変更（クリーンな出力）
    - デフォルトログフォーマットを simple に変更（読みやすさ向上）
    - システムモニタリングをデフォルト無効化（不要な情報を非表示）
    - 段階的詳細化オプション（--log-level, --enable-monitoring）の実装
    - 移行ガイドとヘルプメッセージの更新
    - _要件: 要件 4（CLI ユーザビリティとデフォルト設定）_

  - [x] 7.2 export コマンド機能の実装

    - すべての必要オプションを持つ export コマンドをコード化
    - Change Calendar と祝日統合を追加
    - 出力ファイル処理と検証を実装
    - _要件: 要件 1, 要件 2_

  - [x] 7.3 祝日管理コマンドの追加

    - holidays, check-holiday, refresh-holidays コマンドをコード化
    - 祝日チェックと検証コマンドを実装
    - データ更新と管理コマンドを追加
    - _要件: 要件 1_

  - [x] 7.3.1 holidays コマンドの当年以降データ出力動作の実装

    - `--year`指定なしの場合の当年以降全データ表示機能を実装
    - 内閣府CSVの年度範囲自動検出機能を追加
    - 年別グループ化表示と統計情報表示を実装
    - ICS出力時の`convert_holidays_to_events()`メソッド使用を実装
    - 特定年指定時の後方互換性を維持
    - _要件: 要件 4.1（CLIコマンドの当年以降データ出力動作）_

  - [x] 7.3.2 holidays コマンドの日曜祝日フィルタリング整合性修正

    - 表示部分とICS出力部分で一貫した日曜祝日除外処理を実装
    - `filter_sunday_holidays()`メソッドを表示処理にも適用
    - 除外された日曜祝日の明示的表示機能を追加（特定年指定時）
    - 表示件数とICSファイルのイベント数の整合性を確保
    - _要件: 要件 2.6（日曜祝日フィルタリング）、要件 4.1_

  - [x] 7.4 カレンダー一覧と状態コマンドの実装

    - list-calendars コマンドで Change Calendar 発見と一覧をコード化
    - カレンダー状態チェック機能を追加
    - 状態レポートと診断を実装
    - _要件: 要件 1, 要件 4.3_

  - [x] 7.5 CLI AWS Change Calendar 管理コマンドの実装

    - create-calendar, update-calendar, delete-calendar コマンドを追加
    - analyze-calendar コマンドで AWS Change Calendar 解析機能を追加
    - compare-calendars コマンドで複数 AWS Change Calendar 比較機能を追加
    - _要件: 要件 3, 要件 4, 要件 4.3_

  - [ ]\* 7.6 CLI 統合テストの作成
    - tests/test_cli.py にエンドツーエンドコマンド実行テストを作成
    - エラーハンドリングとエッジケースのテストを作成
    - 出力フォーマットとファイル生成をテスト
    - _要件: 設計書拡張機能_

- [x] 8. エラーハンドリングとログ機能の追加 (設計書拡張機能)

  - [x] 8.1 エラーハンドリングフレームワークの実装

    - 異なるエラータイプ用のカスタム例外クラスを作成
    - エラー回復戦略とフォールバックメカニズムを追加
    - ユーザーフレンドリーなエラーメッセージを実装
    - _要件: 設計書拡張機能_

  - [x] 8.2 ログとモニタリング機能の追加

    - 適切なレベルでの構造化ログを実装
    - パフォーマンス監視とメトリクスを追加
    - デバッグモードと詳細出力を実装
    - _要件: 設計書拡張機能_

  - [ ]\* 8.3 エラーハンドリングテストの作成
    - 全エラーシナリオのテストを作成
    - 回復メカニズムのテストを作成
    - ログ出力とフォーマットをテスト
    - _要件: 設計書拡張機能_

- [x] 9. パフォーマンス最適化とキャッシュの実装 (設計書拡張機能)

  - [x] 9.1 メモリ管理と最適化の追加

    - 祝日データ保存用の効率的なデータ構造を実装
    - 大規模データセット用の遅延読み込みを追加
    - メモリ使用量監視と制限を実装
    - _要件: 設計書拡張機能_

  - [x] 9.2 キャッシュ戦略の実装

    - 祝日データ用の多層キャッシュを実装
    - キャッシュ無効化と更新ロジックを追加
    - キャッシュ統計と監視を実装
    - _要件: 要件 1 (キャッシュ機能拡張)_

  - [x] 9.3 パフォーマンステストとベンチマークの作成
    - 重要な操作のパフォーマンステストスイートを作成
    - 祝日検索と ICS 生成のベンチマークを作成
    - メモリ使用量とリソース消費をテスト
    - _要件: 設計書拡張機能_

- [x] 10. セキュリティ機能と入力検証の追加 (設計書拡張機能)

  - [x] 10.1 入力検証とサニタイゼーションの実装

    - src/security.py に InputValidator クラスを作成
    - 日付入力検証（validate_date）を実装
    - カレンダー名サニタイゼーション（validate_calendar_name）を実装
    - ファイルパス検証とパストラバーサル保護（validate_file_path）を実装
    - _要件: 設計書拡張機能_

  - [x] 10.2 ファイルとネットワーク操作のセキュリティ制御追加

    - セキュアなファイル権限処理（600/644 権限設定）を実装
    - HTTPS 専用ネットワーク接続検証を実装
    - 認証情報保護とセキュアストレージを追加
    - SSL 証明書検証を強制実装
    - _要件: 設計書拡張機能_

  - [x] 10.3 既存モジュールへのセキュリティ統合

    - CLI 入力検証を src/cli.py に統合
    - ファイル操作セキュリティを src/config.py、src/ics_generator.py に統合
    - ネットワークセキュリティを src/japanese_holidays.py、src/aws_client.py に統合
    - _要件: 設計書拡張機能_

  - [x] 10.4 セキュリティテストの作成
    - tests/test_security.py に入力検証テストを作成
    - ファイル権限処理のテストを作成
    - ネットワークセキュリティと認証情報保護をテスト
    - _要件: 設計書拡張機能_

- [x] 11. ドキュメントと使用例の作成 (設計書拡張機能)

  - [x] 11.1 包括的な API ドキュメントの作成

    - 例付きの詳細な API リファレンスを作成
    - 使用ガイドとベストプラクティスを追加
    - トラブルシューティングと FAQ セクションを作成
    - _要件: 設計書拡張機能_

  - [x] 11.2 サンプルスクリプトと使用例の追加

    - 一般的なシナリオのサンプルスクリプトを作成
    - 他ツールとの統合例を作成
    - サンプル設定ファイルを追加
    - _要件: 設計書拡張機能_

  - [x] 11.3 ユーザードキュメントの作成
    - インストールとセットアップガイドを作成
    - コマンドライン使用ドキュメントを追加
    - トラブルシューティングガイドを作成
    - _要件: 設計書拡張機能_

- [x] 12. テストと品質保証の実装 (設計書拡張機能)

  - [x] 12.1 包括的テストスイートのセットアップ

    - 高カバレッジのユニットテストフレームワークを作成
    - 外部依存関係の統合テストを追加
    - エンドツーエンドテストシナリオを実装
    - _要件: 全要件_

  - [x] 12.2 コード品質とリンティングツールの追加

    - コードフォーマットとスタイルチェックを設定
    - 静的解析とセキュリティスキャンを追加
    - 自動品質ゲートを実装
    - _要件: 設計書拡張機能_

  - [x] 12.3 継続的インテグレーションパイプラインの作成
    - 複数 Python バージョンでの自動テストをセットアップ
    - コードカバレッジレポートと品質メトリクスを追加
    - 自動セキュリティと依存関係スキャンを実装
    - _要件: 設計書拡張機能_

- [x] 13. イベント意味的 Diff 形式比較の実装 (src/calendar_analyzer.py 拡張)

  - [x] 13.1 イベント意味的 diff アルゴリズムの実装

    - src/calendar_analyzer.py の ICSAnalyzer クラスに UID ベース主キーマッチングを実装
    - DTSTART/SUMMARY 副キーマッチングロジックを追加
    - 詳細なイベント変更分類 (added/deleted/modified/moved/duration_changed) をコード化
    - _要件: 要件 4.2_

  - [x] 13.2 意味的 diff 出力フォーマットの実装

    - 変更種別可視化用の ANSI カラーコードサポートを追加
    - 意味的 diff 記号 (+, -, ~, =, Δ) フォーマットをコード化
    - DTSTART による時系列ソートを実装
    - _要件: 要件 4.2_

  - [x] 13.3 詳細変更検出と統計の追加

    - プロパティレベル変更検出 (DTSTART, DTEND, SUMMARY, DESCRIPTION) をコード化
    - 変更統計計算と表示を実装
    - 期間変更とイベント移動検出を追加
    - _要件: 要件 4.2_

  - [x] 13.4 既存比較システムとの意味的 diff 統合

    - ICSAnalyzer クラスを意味的 diff メソッドで拡張
    - 既存比較機能に意味的 diff フォーマットオプションを追加
    - 意味的 diff 出力の CLI 統合を実装
    - _要件: 要件 4.2_

  - [x] 13.5 イベント意味的 diff テストの作成

    - tests/test_calendar_analyzer.py にイベントマッチングアルゴリズム精度のテストを作成
    - 変更分類と統計のテストを作成
    - カラー出力と時系列ソートをテスト
    - 既存比較システムとの統合をテスト
    - _要件: 要件 4.2_

- [x] 14. AWS Change Calendar 統合比較の実装 (src/calendar_analyzer.py 拡張)

  - [x] 14.1 AWS Change Calendar クライアント実装の追加

    - src/calendar_analyzer.py に boto3 SSM クライアントを Change Calendar 操作用に実装
    - AWS 認証とエラーハンドリングを追加
    - Change Calendar ドキュメント取得と状態チェックをコード化
    - _要件: 要件 4.3_

  - [x] 14.2 AWS Change Calendar データ正規化の実装

    - AWS Change Calendar → ICS 形式変換を追加
    - 比較用データ構造正規化をコード化
    - AWS イベント用 UID 生成を実装
    - _要件: 要件 4.3_

  - [x] 14.3 AWS Change Calendar 比較機能の追加

    - 意味的 diff を AWS Change Calendar 比較サポートに拡張
    - AWS 固有比較ロジックと統計をコード化
    - Change Calendar 状態統合を実装
    - _要件: 要件 4.3_

  - [x] 14.4 AWS 比較出力フォーマットの実装

    - AWS Change Calendar 固有出力フォーマットを追加
    - 推奨事項とアクション項目生成をコード化
    - バッチ比較結果フォーマットを実装
    - _要件: 要件 4.3_

  - [x] 14.5 バッチ比較と CLI 統合の追加

    - 複数 Change Calendar バッチ比較をコード化
    - src/cli.py に AWS Change Calendar 操作用 CLI コマンドを追加
    - AWS 操作の包括的エラーハンドリングを実装
    - _要件: 要件 4.3_

  - [ ]\* 14.6 AWS Change Calendar 統合テストの作成
    - tests/test_calendar_analyzer.py に AWS Change Calendar クライアント操作のテストを作成
    - データ正規化と比較のテストを作成
    - エラーハンドリングとエッジケースをテスト
    - CLI 統合とバッチ操作をテスト
    - _要件: 要件 4.3_

- [-] 15. ICS ファイル専用 CLI 統合の実装

  - [x] 15.1 基本 ICS ファイル操作 CLI の実装

    - analyze-ics コマンドで ICS ファイル解析機能の CLI 統合を実装
    - compare-ics コマンドで ICS ファイル比較機能の CLI 統合を実装
    - semantic-diff コマンドで意味的差分比較機能の CLI 統合を実装
    - 基本的な出力形式とエラーハンドリングを追加
    - _要件: 要件 3, 要件 4, 要件 4.2_

- [x] 16. 統合テストとエンドツーエンド検証

  - [x] 16.1 コア機能統合テストの実装

    - tests/integration/test_end_to_end.py に祝日データ取得から ICS 生成までのエンドツーエンドテストを作成
    - AWS Change Calendar 作成・更新・削除の統合テストを作成
    - ICS 解析・比較機能の統合テストを作成
    - 実際の AWS 環境での動作検証テストを作成
    - _要件: 要件 1, 要件 2, 要件 3, 要件 4_

  - [x] 16.2 CLI 統合テストの実装

    - tests/integration/test_cli_integration.py に全 CLI コマンドのエンドツーエンドテストを作成
    - エラーハンドリングとエッジケースのテストを作成
    - 出力フォーマットとファイル生成の検証テストを作成
    - コマンドライン引数とオプションの組み合わせテストを作成
    - _要件: 全要件_

  - [x] 16.3 パフォーマンスと品質検証

    - tests/performance/ ディレクトリに大容量データでのパフォーマンステストを実装
    - メモリ使用量とリソース消費の検証を追加
    - コードカバレッジ測定と品質ゲートを実装
    - ベンチマークテストとパフォーマンス回帰検出を実装
    - _要件: 設計書拡張機能_

- [x] 17. ドキュメントと使用例の完成

  - [x] 17.1 ユーザードキュメントの作成

    - README.md の詳細化（インストール、設定、使用例）
    - CLI コマンドリファレンスの作成
    - トラブルシューティングガイドの作成
    - _要件: 設計書拡張機能_

  - [x] 17.1.1 CLI デフォルト設定変更のドキュメント更新

    - README.md に新しいデフォルト設定の説明セクションを追加
    - 段階的詳細化レベルの使用例を追加
    - 移行ガイド（v1.0.x 以前のユーザー向け）を追加
    - ヘルプ出力例の更新
    - _要件: 要件 4（CLI ユーザビリティとデフォルト設定）_

  - [x] 17.2 開発者ドキュメントの作成

    - API リファレンスドキュメントの作成
    - アーキテクチャ図と設計説明の追加
    - 拡張・カスタマイズガイドの作成
    - _要件: 設計書拡張機能_

  - [x] 17.3 サンプルとテンプレートの作成

    - 設定ファイルテンプレートの作成
    - 使用例スクリプトの作成
    - CI/CD パイプライン例の作成
    - _要件: 設計書拡張機能_

- [x] 18. 最終統合と品質保証

  - [x] 18.1 全機能統合検証

    - 全要件（要件 1-4、要件 4.2、要件 4.3）の動作確認
    - エラーハンドリングとログ機能の統合検証
    - パフォーマンス最適化機能の統合検証
    - セキュリティ機能の統合検証
    - _要件: 全要件_

  - [x] 18.2 本番環境準備

    - パッケージング（setup.py、pyproject.toml）の最終確認
    - 依存関係（requirements.txt、requirements-dev.txt）の最終確認
    - エントリーポイント設定の検証
    - インストール手順の検証
    - _要件: 設計書拡張機能_

  - [x] 18.3 リリース準備

    - バージョン管理とタグ付け
    - CHANGELOG.md の作成
    - リリースノートの作成
    - PyPI パッケージ準備（将来対応）
    - _要件: 設計書拡張機能_
